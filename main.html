<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sleeper League Trades</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        #input-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        input,
        button,
        select {
            padding: 10px;
            font-size: 1rem;
        }

        button {
            cursor: pointer;
        }

        #results {
            max-width: 900px;
            margin: 0 auto;
        }

        .trade-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .trade-card h3 {
            margin: 0 0 10px;
        }

        .trade-entry {
            margin: 5px 0;
            padding-left: 10px;
            border-left: 3px solid #4a90e2;
        }

        .toggle-json {
            margin-bottom: 5px;
            cursor: pointer;
        }

        pre {
            background: #eef;
            padding: 10px;
            border-radius: 6px;
            overflow: auto;
        }

        #filters-container {
            display: none;
            /* initially hidden */
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>Sleeper Fantasy League Trades</h1>

    <div id="input-container">
        <input id="leagueId" type="text" placeholder="Enter League ID" />
        <button onclick="loadTrades()">Load Trades</button>
    </div>

    <div id="filters-container" style="display:none;">
        <select id="seasonSelect">
            <option value="">All Seasons</option>
        </select>
        <select id="ownerSelect">
            <option value="">All Owners</option>
        </select>
    </div>

    <div id="results"></div>

    <script src="players.js"></script>
    <script>
        let allTrades = [];
        let userMap = {};
        let rosterMap = {};
        let leagueMap = {};

        const seasonSelect = document.getElementById('seasonSelect');
        const ownerSelect = document.getElementById('ownerSelect');

        seasonSelect.addEventListener('change', renderTrades);
        ownerSelect.addEventListener('change', renderTrades);

        async function loadTrades() {
            const leagueId = document.getElementById('leagueId').value.trim();
            if (!leagueId) return alert('Please enter a league ID');

            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = 'Loading...';

            try {
                // Fetch users and rosters
                const users = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/users`).then(r => r.json());
                const rosters = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/rosters`).then(r => r.json());

                // Get all league IDs (past seasons)
                leagueMap = await getAllLeagueIds(leagueId);

                // Map user_id -> { displayName, teamName }
                userMap = {};
                users.forEach(user => {
                    userMap[user.user_id] = {
                        displayName: user.display_name,
                        teamName: user.metadata?.team_name || user.display_name
                    };
                });

                // Map roster_id -> { displayName, teamName }
                rosterMap = {};
                rosters.forEach(roster => {
                    const ownerId = roster.owner_id;
                    const userInfo = userMap[ownerId];
                    rosterMap[roster.roster_id] = {
                        displayName: userInfo?.displayName || 'Unknown',
                        teamName: userInfo?.teamName || 'Unknown'
                    };
                });

                // Show filters and populate
                const filtersContainer = document.getElementById('filters-container');
                filtersContainer.style.display = 'flex';
                filtersContainer.style.gap = '10px';
                filtersContainer.style.marginBottom = '20px';

                // Populate season dropdown
                seasonSelect.innerHTML = '<option value="">All Seasons</option>';
                for (const season of Object.keys(leagueMap).sort((a, b) => b - a)) {
                    seasonSelect.innerHTML += `<option value="${season}">${season}</option>`;
                }

                // Populate owner dropdown
                ownerSelect.innerHTML = '<option value="">All Owners</option>';
                Object.values(rosterMap).forEach(r => {
                    ownerSelect.innerHTML += `<option value="${r.displayName}">${r.teamName} (${r.displayName})</option>`;
                });

                // Fetch trades from all leagues
                allTrades = await getAllTrades(leagueMap);

                // Initial render
                renderTrades();
            } catch (err) {
                console.error(err);
                resultsEl.innerHTML = '<p>Error loading trades.</p>';
            }
        }

        function renderTrades() {
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = ''; // clear previous

            const selectedSeason = seasonSelect.value;
            const selectedOwner = ownerSelect.value;

            let filteredTrades = allTrades;

            // Filter by season
            if (selectedSeason) {
                filteredTrades = filteredTrades.filter(t => t.season === selectedSeason);
            }

            // Filter by owner
            if (selectedOwner) {
                filteredTrades = filteredTrades.filter(t =>
                    t.roster_ids.some(rid => rosterMap[rid]?.displayName === selectedOwner)
                );
            }

            if (filteredTrades.length === 0) {
                resultsEl.innerHTML = '<p>No trades found for selected filters.</p>';
                return;
            }

            // Render trades
            let html = '';
            filteredTrades.forEach((t, i) => {
                html += `<div class="trade-card">`;
                html += `<h3>Trade #${i + 1} - Season ${t.season}</h3>`;

                const adds = t.adds || {};
                const draftPicks = t.draft_picks || [];
                const waivers = t.waiver_budget || [];
                const grouped = {};

                // Players
                Object.entries(adds).forEach(([playerId, rosterId]) => {
                    const p = players[playerId];
                    const fullName = p?.full_name || p?.last_name || `Player ${playerId}`;
                    grouped[rosterId] = grouped[rosterId] || [];
                    grouped[rosterId].push(`received <em>${fullName}</em>`);
                });

                // Draft picks
                draftPicks.forEach(dp => {
                    const receiver = dp.owner_id;
                    const label = `Pick ${dp.season} Round ${dp.round} (${rosterMap[dp.roster_id]?.displayName || "Unknown"})`;
                    grouped[receiver] = grouped[receiver] || [];
                    grouped[receiver].push(`received <em>${label}</em>`);
                });

                // FAAB
                waivers.forEach(w => {
                    const receiver = w.receiver;
                    grouped[receiver] = grouped[receiver] || [];
                    grouped[receiver].push(`received <em>$${w.amount} FAAB</em>`);
                });

                // Display grouped entries
                t.roster_ids.forEach(rid => {
                    if (!grouped[rid]) return;
                    const userName = rosterMap[rid]?.teamName + " (" + rosterMap[rid]?.displayName + ")";
                    html += `<div class="trade-entry"><strong>${userName}</strong><ul>`;
                    grouped[rid].forEach(it => html += `<li>${it}</li>`);
                    html += `</ul></div>`;
                });

                // Toggle button
                html += `<button class="toggle-json" data-index="${i}">Show JSON</button>`;
                html += `<pre id="json-${i}" style="display:none;">${JSON.stringify(t, null, 2)}</pre>`;

                html += `</div>`;
            });

            resultsEl.innerHTML = html;

            // Attach toggle listeners
            document.querySelectorAll('.toggle-json').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.dataset.index;
                    const pre = document.getElementById(`json-${index}`);
                    if (pre.style.display === 'none') {
                        pre.style.display = 'block';
                        btn.textContent = 'Hide JSON';
                    } else {
                        pre.style.display = 'none';
                        btn.textContent = 'Show JSON';
                    }
                });
            });
        }

        async function getAllTrades(leagueMap) {
            const trades = [];
            for (const [season, leagueId] of Object.entries(leagueMap)) {
                for (let week = 1; week <= 18; week++) {
                    try {
                        const weekTx = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/transactions/${week}`).then(r => r.json());
                        trades.push(...weekTx.map(t => ({ ...t, season })));
                    } catch (err) {
                        console.warn(`Failed to fetch trades for league ${leagueId} week ${week}`, err);
                    }
                }
            }
            return trades.filter(t => t.type === 'trade');
        }

        async function getAllLeagueIds(startLeagueId) {
            const leagueMap = {};
            let currentId = startLeagueId;

            while (currentId) {
                const res = await fetch(`https://api.sleeper.app/v1/league/${currentId}`);
                const league = await res.json();
                leagueMap[league.season] = league.league_id;
                currentId = league.previous_league_id || null;
            }

            return leagueMap;
        }
    </script>
</body>

</html>