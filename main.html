<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sleeper League Trades</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        #input-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        input,
        button {
            padding: 10px;
            font-size: 1rem;
        }

        button {
            cursor: pointer;
        }

        #results {
            max-width: 900px;
            margin: 0 auto;
        }

        .trade-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .trade-card h3 {
            margin: 0 0 10px;
        }

        .trade-entry {
            margin: 5px 0;
            padding-left: 10px;
            border-left: 3px solid #4a90e2;
        }
    </style>
</head>

<body>
    <h1>Sleeper Fantasy League Trades</h1>

    <div id="input-container">
        <input id="leagueId" type="text" placeholder="Enter League ID" />
        <button onclick="loadTrades()">Load Trades</button>
    </div>

    <div id="results"></div>

    <script src="players.js"></script>
    <script>
        async function loadTrades() {
            const leagueId = document.getElementById('leagueId').value.trim();
            if (!leagueId) return alert('Please enter a league ID');

            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = 'Loading...';

            try {
                const users = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/users`).then(r => r.json());
                const rosters = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/rosters`).then(r => r.json());
                getAllLeagueIds(leagueId).then(console.log);

                // Step 1: Map user_id -> { display_name, team_name }
                const userMap = {};
                users.forEach(user => {
                    userMap[user.user_id] = {
                        displayName: user.display_name,
                        teamName: user.metadata?.team_name || user.display_name
                    };
                });

                // Step 2: Map roster_id -> { displayName, teamName }
                const rosterMap = {};
                rosters.forEach(roster => {
                    // Usually, rosters have one owner, sometimes co_owners
                    const ownerId = roster.owner_id; // you could handle co_owners if needed
                    const userInfo = userMap[ownerId];
                    rosterMap[roster.roster_id] = {
                        displayName: userInfo?.displayName || 'Unknown',
                        teamName: userInfo?.teamName || 'Unknown'
                    };
                });

                const allTrades = await getAllTrades(leagueId);

                if (allTrades.length === 0) {
                    resultsEl.innerHTML = '<p>No trades found.</p>';
                    return;
                }

                let html = '';
                allTrades.forEach((t, i) => {
                    html += `<div class="trade-card">`;
                    html += `<h3>Trade #${i + 1}</h3>`;
                    html += `<pre style="background:#eef;padding:10px;border-radius:6px;overflow:auto;">${JSON.stringify(t, null, 2)}</pre>`;

                    const adds = t.adds || {};
                    const draftPicks = t.draft_picks || [];
                    const waivers = t.waiver_budget || [];

                    const grouped = {};

                    Object.entries(adds).forEach(([playerId, rosterId]) => {
                        const p = players[playerId];
                        const fullName = p?.full_name || p?.last_name || `Player ${playerId}`;
                        grouped[rosterId] = grouped[rosterId] || [];
                        grouped[rosterId].push(`received <em>${fullName}</em>`);
                    });

                    draftPicks.forEach(dp => {
                        const receiver = dp.owner_id;
                        const sender = dp.previous_owner_id;
                        const label = `Pick ${dp.season} Round ${dp.round} (${rosterMap[dp.roster_id].displayName})`;
                        grouped[receiver] = grouped[receiver] || [];
                        grouped[receiver].push(`received <em>${label}</em>`);
                    });

                    // FAAB / waiver budget
                    waivers.forEach(w => {
                        const receiver = w.receiver;
                        grouped[receiver] = grouped[receiver] || [];
                        grouped[receiver].push(`received <em>$${w.amount} FAAB</em>`);
                    });

                    // Group by roster order from transaction for stable output
                    t.roster_ids.forEach(rid => {
                        if (!grouped[rid]) return;
                        const userName = rosterMap[rid].teamName + " (" + rosterMap[rid].displayName + ")";
                        html += `<div class="trade-entry"><strong>${userName}</strong><ul>`;
                        grouped[rid].forEach(it => html += `<li>${it}</li>`);
                        html += `</ul></div>`;
                    });

                    html += `</div>`;
                });

                resultsEl.innerHTML = html;
            } catch (err) {
                console.error(err);
                resultsEl.innerHTML = '<p>Error loading trades.</p>';
            }
        }

        async function getAllTrades(startLeagueId) {
            const leagueMap = await getAllLeagueIds(startLeagueId); // { season -> leagueId }
            const allTrades = [];

            for (const [season, leagueId] of Object.entries(leagueMap)) {
                for (let week = 1; week <= 18; week++) {
                    try {
                        const weekTx = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/transactions/${week}`).then(r => r.json());
                        allTrades.push(...weekTx.map(t => ({ ...t, season }))); // add season to each trade
                    } catch (err) {
                        console.warn(`Failed to fetch trades for league ${leagueId} week ${week}`, err);
                    }
                }
            }

            // filter only trades (type === 'trade')
            return allTrades.filter(t => t.type === 'trade');
        }

        async function getAllLeagueIds(startLeagueId) {
            const leagueMap = {}; // season -> league_id
            let currentId = startLeagueId;

            while (currentId) {
                const res = await fetch(`https://api.sleeper.app/v1/league/${currentId}`);
                const league = await res.json();

                // save league id by season
                leagueMap[league.season] = league.league_id;

                // move to previous league
                currentId = league.previous_league_id || null;
            }

            return leagueMap;
        }

    </script>
</body>

</html>